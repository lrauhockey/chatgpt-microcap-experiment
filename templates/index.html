<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Predictor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .stock-card {
            transition: transform 0.2s;
        }
        .stock-card:hover {
            transform: translateY(-5px);
        }
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        .loading {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">üöÄ Stock Market Predictor & Portfolio Manager</h1>
                <p class="text-center text-muted">Get real-time stock quotes, manage your portfolio, and track investments</p>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="row mb-4">
            <div class="col-12">
                <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="quotes-tab" data-bs-toggle="tab" data-bs-target="#quotes" type="button" role="tab">üìä Stock Quotes</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="portfolio-tab" data-bs-toggle="tab" data-bs-target="#portfolio" type="button" role="tab">üíº Portfolio</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="trade-tab" data-bs-toggle="tab" data-bs-target="#trade" type="button" role="tab">üí∞ Buy/Sell</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">üìã Transactions</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ai-predictor-tab" data-bs-toggle="tab" data-bs-target="#ai-predictor" type="button" role="tab">ü§ñ AI Predictor</button>
                    </li>
                </ul>
            </div>
        </div>

        <div class="tab-content" id="mainTabContent">
            <!-- Stock Quotes Tab -->
            <div class="tab-pane fade" id="quotes" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-8 mx-auto">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Get Stock Quote</h5>
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="stockSymbol" placeholder="Enter stock symbol (e.g., AAPL, GOOGL, TSLA)" value="AAPL">
                                    <button class="btn btn-primary" type="button" id="getQuoteBtn">Get Quote</button>
                                </div>
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="multipleSymbols" placeholder="Multiple symbols (comma-separated): AAPL,GOOGL,TSLA">
                                    <button class="btn btn-secondary" type="button" id="getMultipleBtn">Get Multiple</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio Tab -->
            <div class="tab-pane fade show active" id="portfolio" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Portfolio Summary</h5>
                                <div id="portfolioSummary">
                                    <div class="text-center">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row" id="holdingsContainer"></div>

                <!-- Performance Chart Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="card-title">üìà Portfolio Performance</h5>
                                    <div>
                                        <button class="btn btn-outline-primary btn-sm me-2" id="refreshDataBtn">
                                            üîÑ Refresh Data
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" id="refreshQuotesBtn">
                                            üí∞ Override Cache
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Performance Chart -->
                                <div id="performanceChartContainer" style="display: none;">
                                    <canvas id="performanceChart" width="400" height="200"></canvas>
                                </div>
                                
                                <!-- Performance Summary -->
                                <div id="performanceSummary" class="mt-3" style="display: none;">
                                    <div class="row text-center">
                                        <div class="col-md-6">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6 class="card-title">Total Gain/Loss</h6>
                                                    <h4 id="totalGainLoss" class="mb-0">$0.00</h4>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6 class="card-title">Total Return %</h6>
                                                    <h4 id="totalGainLossPercent" class="mb-0">0.00%</h4>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="performanceLoading" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading performance data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buy/Sell Tab -->
            <div class="tab-pane fade" id="trade" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title text-success">üí∞ Buy Stock</h5>
                                <form id="buyForm">
                                    <div class="mb-3">
                                        <label for="buyTicker" class="form-label">Stock Symbol</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="buyTicker" placeholder="e.g., AAPL" required>
                                            <button type="button" class="btn btn-outline-primary" id="lookupPriceBtn">
                                                üìä Lookup Price
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="buyQuantity" class="form-label">Quantity</label>
                                        <input type="number" class="form-control" id="buyQuantity" min="1" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="buyPrice" class="form-label">Purchase Price ($)</label>
                                        <input type="number" class="form-control" id="buyPrice" step="0.01" min="0.01" placeholder="Enter price per share" required>
                                        <div class="form-text">Current market price will be fetched automatically</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Total Cost</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="text" class="form-control" id="totalCost" readonly>
                                            <span class="input-group-text" id="cashValidation">üí∞</span>
                                        </div>
                                        <div class="form-text">
                                            Available Cash: $<span id="availableCash">0.00</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="buyReason" class="form-label">Reason</label>
                                        <input type="text" class="form-control" id="buyReason" placeholder="Why are you buying?" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="buyStopPrice" class="form-label">Stop Price (Optional)</label>
                                        <input type="number" class="form-control" id="buyStopPrice" step="0.01" placeholder="Stop loss price">
                                    </div>
                                    <button type="submit" class="btn btn-success w-100" id="buySubmitBtn">Buy Stock</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title text-danger">üìâ Sell Stock</h5>
                                <form id="sellForm">
                                    <div class="mb-3">
                                        <label for="sellTicker" class="form-label">Stock Symbol</label>
                                        <input type="text" class="form-control" id="sellTicker" placeholder="e.g., AAPL" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="sellQuantity" class="form-label">Quantity</label>
                                        <input type="number" class="form-control" id="sellQuantity" min="1" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="sellReason" class="form-label">Reason</label>
                                        <input type="text" class="form-control" id="sellReason" placeholder="Why are you selling?" required>
                                    </div>
                                    <button type="submit" class="btn btn-danger w-100">Sell Stock</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <strong>üí° How it works:</strong> Enter a stock symbol and quantity. The system will automatically get the current market price and execute your trade.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div class="tab-pane fade" id="transactions" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Transaction History</h5>
                                <div id="transactionsContainer">
                                    <div class="text-center">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Predictor Tab -->
            <div class="tab-pane fade" id="ai-predictor" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">ü§ñ AI Stock Recommendations</h5>
                                <p class="text-muted">Get AI-powered buy and sell recommendations based on your current portfolio</p>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="useOpenAIPriceCheckbox">
                                        <label class="form-check-label" for="useOpenAIPriceCheckbox">
                                            <strong>Use OpenAI Price</strong> - Skip live stock API calls and use AI-provided prices
                                        </label>
                                    </div>
                                </div>
                                
                                <button class="btn btn-primary" id="getRecommendationsBtn">
                                    <span class="spinner-border spinner-border-sm d-none" id="aiLoadingSpinner"></span>
                                    Get AI Recommendations
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sell Recommendations -->
                <div class="row mb-4" id="sellRecommendationsSection" style="display: none;">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title text-warning">üìâ Sell/Hold Recommendations</h5>
                                <div id="sellRecommendationsContainer"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Buy Recommendations -->
                <div class="row mb-4" id="buyRecommendationsSection" style="display: none;">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title text-success">üìà Buy Recommendations</h5>
                                
                                <!-- Running Cash Total Display -->
                                <div class="alert alert-info mb-3" id="cashTotalDisplay" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <strong>üí∞ Current Cash:</strong> <span id="currentCash">$0</span>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>üìâ Selected Costs:</strong> <span id="selectedCosts">$0</span>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>üíµ Remaining Cash:</strong> <span id="remainingCash">$0</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="buyRecommendationsContainer"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Execute Trades Button -->
                <div class="row mb-4" id="executeTradesSection" style="display: none;">
                    <div class="col-12 text-center">
                        <button class="btn btn-danger btn-lg" id="executeTradesBtn">
                            <span class="spinner-border spinner-border-sm d-none" id="executeLoadingSpinner"></span>
                            üöÄ Execute Selected Trades
                        </button>
                        <p class="text-muted mt-2">Only checked recommendations will be executed</p>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="row" id="aiResultsSection" style="display: none;">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Execution Results</h5>
                                <div id="aiResultsContainer"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="row loading" id="loadingSpinner">
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Fetching stock data...</p>
            </div>
        </div>

        <!-- Stock Quote Results -->
        <div class="row" id="stockResults"></div>

        <!-- Historical Data Chart -->
        <div class="row mt-4" id="chartContainer" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Historical Data</h5>
                        <canvas id="stockChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let stockChart = null;

        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('stockResults').innerHTML = '';
            document.getElementById('chartContainer').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        function displayStockQuote(quote) {
            const changeClass = quote.change >= 0 ? 'positive' : 'negative';
            const changeIcon = quote.change >= 0 ? 'üìà' : 'üìâ';
            const apiSourceBadge = quote.api_source ? `<span class="badge bg-info ms-2">${quote.api_source}</span>` : '';
            
            return `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card stock-card h-100">
                        <div class="card-body">
                            <h5 class="card-title">${quote.symbol} ${changeIcon} ${apiSourceBadge}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">${quote.name}</h6>
                            <p class="card-text">
                                <strong class="fs-4">$${quote.current_price}</strong><br>
                                <span class="${changeClass}">
                                    ${quote.change >= 0 ? '+' : ''}${quote.change} (${quote.change_percent >= 0 ? '+' : ''}${quote.change_percent}%)
                                </span>
                            </p>
                            <small class="text-muted">
                                Volume: ${quote.volume?.toLocaleString() || 'N/A'}<br>
                                Updated: ${quote.timestamp}
                            </small>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="getHistoricalData('${quote.symbol}')">
                                    View Chart
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function getStockQuote(symbol) {
            showLoading();
            try {
                const response = await fetch(`/api/quote/${symbol}`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('stockResults').innerHTML = displayStockQuote(data);
                } else {
                    document.getElementById('stockResults').innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger" role="alert">
                                Error: ${data.error}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('stockResults').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger" role="alert">
                            Error fetching data: ${error.message}
                        </div>
                    </div>
                `;
            }
            hideLoading();
        }

        async function getMultipleQuotes(symbols) {
            showLoading();
            try {
                const response = await fetch(`/api/multiple?symbols=${symbols}`);
                const data = await response.json();
                
                if (response.ok && data.quotes.length > 0) {
                    let html = '';
                    data.quotes.forEach(quote => {
                        html += displayStockQuote(quote);
                    });
                    document.getElementById('stockResults').innerHTML = html;
                } else {
                    document.getElementById('stockResults').innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-warning" role="alert">
                                No valid stock data found for the provided symbols.
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('stockResults').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger" role="alert">
                            Error fetching data: ${error.message}
                        </div>
                    </div>
                `;
            }
            hideLoading();
        }

        async function getHistoricalData(symbol) {
            try {
                const response = await fetch(`/api/historical/${symbol}?period=1mo`);
                const data = await response.json();
                
                if (response.ok) {
                    displayChart(data);
                }
            } catch (error) {
                console.error('Error fetching historical data:', error);
            }
        }

        function displayChart(data) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            
            if (stockChart) {
                stockChart.destroy();
            }

            const labels = data.data.map(item => item.date);
            const prices = data.data.map(item => item.close);

            stockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${data.symbol} Close Price`,
                        data: prices,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Price ($)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });

            document.getElementById('chartContainer').style.display = 'block';
        }

        // Event listeners
        document.getElementById('getQuoteBtn').addEventListener('click', () => {
            const symbol = document.getElementById('stockSymbol').value.trim();
            if (symbol) {
                getStockQuote(symbol);
            }
        });

        document.getElementById('getMultipleBtn').addEventListener('click', () => {
            const symbols = document.getElementById('multipleSymbols').value.trim();
            if (symbols) {
                getMultipleQuotes(symbols);
            }
        });

        // Allow Enter key to trigger search
        document.getElementById('stockSymbol').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('getQuoteBtn').click();
            }
        });

        document.getElementById('multipleSymbols').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('getMultipleBtn').click();
            }
        });

        // Portfolio management functions
        async function loadPortfolioSummary() {
            try {
                const response = await fetch('/api/portfolio/summary');
                const data = await response.json();
                
                if (response.ok) {
                    displayPortfolioSummary(data);
                } else {
                    document.getElementById('portfolioSummary').innerHTML = `
                        <div class="alert alert-danger">Error: ${data.error}</div>
                    `;
                }
            } catch (error) {
                document.getElementById('portfolioSummary').innerHTML = `
                    <div class="alert alert-danger">Error loading portfolio: ${error.message}</div>
                `;
            }
        }

        function displayPortfolioSummary(data) {
            const summaryHtml = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h5>üí∞ Cash Balance</h5>
                                <h3>$${data.cash_balance.toLocaleString()}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h5>üìà Market Value</h5>
                                <h3>$${data.total_market_value.toLocaleString()}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h5>üíº Total Portfolio</h5>
                                <h3>$${data.total_portfolio_value.toLocaleString()}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h5>üìä Holdings</h5>
                                <h3>${data.holdings_count}</h3>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('portfolioSummary').innerHTML = summaryHtml;
            
            // Display holdings
            let holdingsHtml = '';
            data.holdings.forEach(holding => {
                const gainLoss = holding.total_market_value - (holding.quantity * holding.average_cost);
                const gainLossPercent = ((holding.total_market_value / (holding.quantity * holding.average_cost)) - 1) * 100;
                const gainLossClass = gainLoss >= 0 ? 'text-success' : 'text-danger';
                
                holdingsHtml += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">${holding.ticker}</h5>
                                <p class="card-text">
                                    <strong>Quantity:</strong> ${holding.quantity}<br>
                                    <strong>Avg Cost:</strong> $${holding.average_cost.toFixed(2)}<br>
                                    <strong>Market Value:</strong> $${holding.total_market_value.toLocaleString()}<br>
                                    <span class="${gainLossClass}">
                                        <strong>P&L:</strong> ${gainLoss >= 0 ? '+' : ''}$${gainLoss.toFixed(2)} (${gainLossPercent >= 0 ? '+' : ''}${gainLossPercent.toFixed(2)}%)
                                    </span>
                                </p>
                                <div class="d-grid">
                                    <button class="btn btn-danger btn-sm" onclick="sellHolding('${holding.ticker}', ${holding.quantity})">
                                        üìâ Sell ${holding.ticker}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('holdingsContainer').innerHTML = holdingsHtml;
        }

        async function loadTransactions() {
            try {
                const response = await fetch('/api/portfolio/transactions');
                const data = await response.json();
                
                if (response.ok) {
                    displayTransactions(data.transactions);
                } else {
                    document.getElementById('transactionsContainer').innerHTML = `
                        <div class="alert alert-danger">Error: ${data.error}</div>
                    `;
                }
            } catch (error) {
                document.getElementById('transactionsContainer').innerHTML = `
                    <div class="alert alert-danger">Error loading transactions: ${error.message}</div>
                `;
            }
        }

        function displayTransactions(transactions) {
            if (transactions.length === 0) {
                document.getElementById('transactionsContainer').innerHTML = `
                    <div class="alert alert-info">No transactions yet. Start trading to see your history here!</div>
                `;
                return;
            }

            let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Ticker</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Total</th>
                                <th>Reason</th>
                                <th>P&L</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            transactions.reverse().forEach(tx => {
                const isBuy = tx.quantity && tx.buy_price;
                const isSell = tx.sell_quantity && tx.sell_price;
                
                tableHtml += `
                    <tr>
                        <td>${isBuy ? tx.date : tx.sell_date}</td>
                        <td><strong>${tx.ticker}</strong></td>
                        <td>
                            <span class="badge ${isBuy ? 'bg-success' : 'bg-danger'}">
                                ${isBuy ? 'BUY' : 'SELL'}
                            </span>
                        </td>
                        <td>${isBuy ? tx.quantity : tx.sell_quantity}</td>
                        <td>$${isBuy ? parseFloat(tx.buy_price).toFixed(2) : parseFloat(tx.sell_price).toFixed(2)}</td>
                        <td>$${isBuy ? parseFloat(tx.total).toFixed(2) : (tx.sell_quantity * tx.sell_price).toFixed(2)}</td>
                        <td>${tx.reason}</td>
                        <td>
                            ${tx.gain_loss ? 
                                `<span class="${parseFloat(tx.gain_loss) >= 0 ? 'text-success' : 'text-danger'}">
                                    ${parseFloat(tx.gain_loss) >= 0 ? '+' : ''}$${parseFloat(tx.gain_loss).toFixed(2)}
                                </span>` : 
                                '-'
                            }
                        </td>
                    </tr>
                `;
            });

            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('transactionsContainer').innerHTML = tableHtml;
        }

        // Buy form price lookup and calculation functions
        let availableCash = 0;

        async function lookupStockPrice() {
            const ticker = document.getElementById('buyTicker').value.trim().toUpperCase();
            if (!ticker) {
                alert('Please enter a stock symbol first');
                return;
            }

            const lookupBtn = document.getElementById('lookupPriceBtn');
            lookupBtn.disabled = true;
            lookupBtn.innerHTML = '‚è≥ Loading...';

            try {
                const response = await fetch(`/api/quote/${ticker}`);
                const data = await response.json();
                
                if (response.ok && data.price) {
                    document.getElementById('buyPrice').value = data.price.toFixed(2);
                    calculateTotalCost();
                    lookupBtn.innerHTML = '‚úÖ Updated';
                    setTimeout(() => {
                        lookupBtn.innerHTML = 'üìä Lookup Price';
                        lookupBtn.disabled = false;
                    }, 2000);
                } else {
                    alert(`‚ùå Could not fetch price for ${ticker}`);
                    lookupBtn.innerHTML = '‚ùå Failed';
                    setTimeout(() => {
                        lookupBtn.innerHTML = 'üìä Lookup Price';
                        lookupBtn.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                alert(`‚ùå Error fetching price: ${error.message}`);
                lookupBtn.innerHTML = '‚ùå Error';
                setTimeout(() => {
                    lookupBtn.innerHTML = 'üìä Lookup Price';
                    lookupBtn.disabled = false;
                }, 2000);
            }
        }

        function calculateTotalCost() {
            const quantity = parseFloat(document.getElementById('buyQuantity').value) || 0;
            const price = parseFloat(document.getElementById('buyPrice').value) || 0;
            const totalCost = quantity * price;
            
            document.getElementById('totalCost').value = totalCost.toFixed(2);
            
            // Update cash validation
            const cashValidation = document.getElementById('cashValidation');
            const buySubmitBtn = document.getElementById('buySubmitBtn');
            
            if (totalCost > availableCash) {
                cashValidation.innerHTML = '‚ùå';
                cashValidation.className = 'input-group-text text-danger';
                buySubmitBtn.disabled = true;
                buySubmitBtn.innerHTML = 'Insufficient Cash';
            } else if (totalCost > 0) {
                cashValidation.innerHTML = '‚úÖ';
                cashValidation.className = 'input-group-text text-success';
                buySubmitBtn.disabled = false;
                buySubmitBtn.innerHTML = 'Buy Stock';
            } else {
                cashValidation.innerHTML = 'üí∞';
                cashValidation.className = 'input-group-text';
                buySubmitBtn.disabled = false;
                buySubmitBtn.innerHTML = 'Buy Stock';
            }
        }

        async function loadAvailableCash() {
            try {
                const response = await fetch('/api/portfolio/cash');
                const data = await response.json();
                if (response.ok) {
                    availableCash = data.cash_balance;
                    document.getElementById('availableCash').textContent = availableCash.toFixed(2);
                    calculateTotalCost(); // Recalculate validation
                }
            } catch (error) {
                console.error('Error loading cash balance:', error);
            }
        }

        // Buy/Sell form handlers
        document.getElementById('buyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const ticker = document.getElementById('buyTicker').value.trim();
            const quantity = parseInt(document.getElementById('buyQuantity').value);
            const price = parseFloat(document.getElementById('buyPrice').value);
            const reason = document.getElementById('buyReason').value.trim();
            const stopPrice = document.getElementById('buyStopPrice').value;
            
            // Validate inputs
            if (!ticker || !quantity || !price || !reason) {
                alert('Please fill in all required fields');
                return;
            }

            const totalCost = quantity * price;
            if (totalCost > availableCash) {
                alert(`Insufficient cash. Total cost: $${totalCost.toFixed(2)}, Available: $${availableCash.toFixed(2)}`);
                return;
            }
            
            try {
                const response = await fetch('/api/portfolio/buy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ticker,
                        quantity,
                        price: price, // Send the manual price
                        reason,
                        stop_price: stopPrice || null
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ ${data.message}\nTotal Cost: $${data.total_cost.toFixed(2)}\nRemaining Cash: $${data.remaining_cash.toFixed(2)}`);
                    document.getElementById('buyForm').reset();
                    loadPortfolioSummary();
                    loadAvailableCash(); // Refresh cash balance
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        });

        // Event listeners for buy form
        document.getElementById('lookupPriceBtn').addEventListener('click', lookupStockPrice);
        document.getElementById('buyQuantity').addEventListener('input', calculateTotalCost);
        document.getElementById('buyPrice').addEventListener('input', calculateTotalCost);

        // Performance chart variables
        let performanceChart = null;

        async function loadPortfolioPerformance() {
            const loading = document.getElementById('performanceLoading');
            const chartContainer = document.getElementById('performanceChartContainer');
            const summary = document.getElementById('performanceSummary');
            
            loading.style.display = 'block';
            chartContainer.style.display = 'none';
            summary.style.display = 'none';
            
            try {
                const response = await fetch('/api/portfolio/performance');
                const data = await response.json();
                
                if (response.ok) {
                    displayPerformanceChart(data.performance_data);
                    displayPerformanceSummary(data.total_gain_loss, data.total_gain_loss_percent);
                } else {
                    loading.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                }
            } catch (error) {
                loading.innerHTML = `<div class="alert alert-danger">Error loading performance: ${error.message}</div>`;
            }
        }

        function displayPerformanceChart(performanceData) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            // Destroy existing chart
            if (performanceChart) {
                performanceChart.destroy();
            }
            
            console.log('Performance data received:', performanceData);
            
            const labels = performanceData.map(item => item.date);
            const portfolioData = performanceData.map(item => item.portfolio_pct_change || 0);
            const sp500Data = performanceData.map(item => item.sp500_pct_change || 0);
            
            // Determine overall trend for color
            const latestValue = portfolioData[portfolioData.length - 1] || 0;
            const isPositive = latestValue >= 0;
            
            // Create datasets array
            const datasets = [{
                label: 'Portfolio Gain/Loss (%)',
                data: portfolioData,
                borderColor: isPositive ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)',
                backgroundColor: isPositive ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                tension: 0.1,
                fill: false,
                pointBackgroundColor: portfolioData.map(value => 
                    value >= 0 ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)'
                ),
                pointBorderColor: portfolioData.map(value => 
                    value >= 0 ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)'
                ),
                pointRadius: 4
            }];
            
            // Add S&P 500 line if we have data
            const hasValidSP500Data = sp500Data.some(value => value !== 0 && value !== null);
            if (hasValidSP500Data) {
                datasets.push({
                    label: 'S&P 500 (%)',
                    data: sp500Data,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.1,
                    fill: false,
                    pointBackgroundColor: 'rgb(59, 130, 246)',
                    pointBorderColor: 'rgb(59, 130, 246)',
                    pointRadius: 3
                });
            }
            
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Percentage Change (%)'
                            },
                            grid: {
                                color: function(context) {
                                    return context.tick.value === 0 ? 'rgba(0, 0, 0, 0.3)' : 'rgba(0, 0, 0, 0.1)';
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2) + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(3) + '%';
                                }
                            }
                        }
                    }
                }
            });
            
            document.getElementById('performanceChartContainer').style.display = 'block';
            document.getElementById('performanceLoading').style.display = 'none';
        }

        function displayPerformanceSummary(totalGainLoss, totalGainLossPercent) {
            const gainLossElement = document.getElementById('totalGainLoss');
            const percentElement = document.getElementById('totalGainLossPercent');
            
            // Format and color code the values
            const gainLossFormatted = `$${totalGainLoss.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            const percentFormatted = `${totalGainLossPercent.toFixed(2)}%`;
            
            gainLossElement.textContent = gainLossFormatted;
            percentElement.textContent = percentFormatted;
            
            // Color coding
            const color = totalGainLoss >= 0 ? 'text-success' : 'text-danger';
            gainLossElement.className = `mb-0 ${color}`;
            percentElement.className = `mb-0 ${color}`;
            
            document.getElementById('performanceSummary').style.display = 'block';
        }

        async function refreshPortfolioData() {
            const btn = document.getElementById('refreshDataBtn');
            btn.disabled = true;
            btn.innerHTML = 'üîÑ Refreshing...';
            
            try {
                await loadPortfolioSummary();
                await loadPortfolioPerformance();
                btn.innerHTML = '‚úÖ Refreshed';
                setTimeout(() => {
                    btn.innerHTML = 'üîÑ Refresh Data';
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                btn.innerHTML = '‚ùå Error';
                setTimeout(() => {
                    btn.innerHTML = 'üîÑ Refresh Data';
                    btn.disabled = false;
                }, 2000);
            }
        }

        async function refreshQuotes() {
            const btn = document.getElementById('refreshQuotesBtn');
            btn.disabled = true;
            btn.innerHTML = 'üí∞ Refreshing...';
            
            try {
                const response = await fetch('/api/portfolio/refresh-quotes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    btn.innerHTML = '‚úÖ Cache Cleared';
                    // Reload data with fresh quotes
                    await loadPortfolioSummary();
                    await loadPortfolioPerformance();
                } else {
                    btn.innerHTML = '‚ùå Error';
                }
                
                setTimeout(() => {
                    btn.innerHTML = 'üí∞ Override Cache';
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                btn.innerHTML = '‚ùå Error';
                setTimeout(() => {
                    btn.innerHTML = 'üí∞ Override Cache';
                    btn.disabled = false;
                }, 2000);
            }
        }

        document.getElementById('sellForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const ticker = document.getElementById('sellTicker').value.trim();
            const quantity = parseInt(document.getElementById('sellQuantity').value);
            const reason = document.getElementById('sellReason').value.trim();
            
            try {
                const response = await fetch('/api/portfolio/sell', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ticker,
                        quantity,
                        reason
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const gainLossText = data.gain_loss >= 0 ? `Gain: +$${data.gain_loss.toFixed(2)}` : `Loss: $${data.gain_loss.toFixed(2)}`;
                    alert(`‚úÖ ${data.message}\nTotal Proceeds: $${data.total_proceeds.toFixed(2)}\n${gainLossText}\nRemaining Cash: $${data.remaining_cash.toFixed(2)}`);
                    document.getElementById('sellForm').reset();
                    // Refresh portfolio if on portfolio tab
                    if (document.getElementById('portfolio-tab').classList.contains('active')) {
                        loadPortfolioSummary();
                    }
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        });

        // Function to sell a holding - switches to trade tab and pre-fills form
        function sellHolding(ticker, maxQuantity) {
            // Switch to the Buy/Sell tab
            const tradeTab = new bootstrap.Tab(document.getElementById('trade-tab'));
            tradeTab.show();
            
            // Pre-fill the sell form
            document.getElementById('sellTicker').value = ticker;
            document.getElementById('sellQuantity').value = maxQuantity;
            document.getElementById('sellQuantity').max = maxQuantity;
            document.getElementById('sellReason').value = '';
            
            // Focus on the quantity field so user can easily adjust
            setTimeout(() => {
                document.getElementById('sellQuantity').select();
            }, 100);
            
            // Add a helper text showing max quantity
            const quantityField = document.getElementById('sellQuantity');
            const existingHelper = document.getElementById('sellQuantityHelper');
            if (existingHelper) {
                existingHelper.remove();
            }
            
            const helperText = document.createElement('small');
            helperText.id = 'sellQuantityHelper';
            helperText.className = 'form-text text-muted';
            helperText.textContent = `You own ${maxQuantity} shares of ${ticker}`;
            quantityField.parentNode.appendChild(helperText);
        }

        // AI Predictor functions
        let currentRecommendations = null;

        async function getAIRecommendations() {
            const btn = document.getElementById('getRecommendationsBtn');
            const spinner = document.getElementById('aiLoadingSpinner');
            const useOpenAIPrice = document.getElementById('useOpenAIPriceCheckbox').checked;
            
            btn.disabled = true;
            spinner.classList.remove('d-none');
            
            try {
                const response = await fetch('/api/ai/recommendations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        use_openai_price: useOpenAIPrice
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    currentRecommendations = data.recommendations;
                    displayRecommendations(data.recommendations);
                } else {
                    document.getElementById('sellRecommendationsSection').style.display = 'block';
                    document.getElementById('sellRecommendationsContainer').innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Error:</strong> ${data.error || 'Failed to get AI recommendations'}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('sellRecommendationsSection').style.display = 'block';
                document.getElementById('sellRecommendationsContainer').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                spinner.classList.add('d-none');
            }
        }

        function displayRecommendations(recommendations) {
            // Display sell recommendations
            if (recommendations.sell_decisions && recommendations.sell_decisions.length > 0) {
                let sellHtml = '';
                recommendations.sell_decisions.forEach((sell, index) => {
                    const actionClass = sell.action === 'SELL' ? 'danger' : sell.action === 'TRIM' ? 'warning' : 'secondary';
                    const totalValue = (sell.current_price || 0) * (sell.quantity || 0);
                    
                    sellHtml += `
                        <div class="form-check mb-3 p-3 border rounded ai-sell-recommendation" data-index="${index}">
                            <div class="d-flex align-items-start mb-2">
                                <input class="form-check-input sell-checkbox me-2" type="checkbox" id="sell_${index}" 
                                       data-ticker="${sell.ticker}" data-action="${sell.action}" data-index="${index}">
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <strong>${sell.ticker}</strong> 
                                            <span class="badge bg-${actionClass}">${sell.action}</span>
                                        </div>
                                        <div class="text-end">
                                            <a href="https://finance.yahoo.com/quote/${sell.ticker}/" target="_blank" class="btn btn-sm btn-outline-primary">
                                                üìä Yahoo Finance
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <div class="row g-2 mb-2">
                                        <div class="col-md-4">
                                            <label class="form-label small">Quantity</label>
                                            <input type="number" class="form-control form-control-sm ai-sell-quantity" 
                                                   value="${sell.quantity}" min="1" data-index="${index}">
                                            <small class="text-muted">AI suggested: ${sell.quantity}</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Price ($)</label>
                                            <input type="number" class="form-control form-control-sm ai-sell-price" 
                                                   value="${(sell.current_price || 0).toFixed(2)}" step="0.01" min="0.01" data-index="${index}">
                                            <small class="text-muted">Current: $${(sell.current_price || 0).toFixed(2)}</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Total Value</label>
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">$</span>
                                                <input type="text" class="form-control ai-sell-total-value" readonly 
                                                       value="${totalValue.toFixed(2)}" data-index="${index}">
                                                <span class="input-group-text">üí∞</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row g-2 mb-2">
                                        <div class="col-md-12">
                                            <label class="form-label small">Reason</label>
                                            <input type="text" class="form-control form-control-sm ai-sell-reason" 
                                                   value="${sell.reason}" data-index="${index}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('sellRecommendationsContainer').innerHTML = sellHtml;
                document.getElementById('sellRecommendationsSection').style.display = 'block';
                
                // Add event listeners for sell recommendations
                addAISellRecommendationListeners();
            }

            // Display buy recommendations
            if (recommendations.buy_recommendations && recommendations.buy_recommendations.length > 0) {
                let buyHtml = '';
                recommendations.buy_recommendations.forEach((buy, index) => {
                    const totalCost = (buy.current_price || 0) * (buy.quantity || 0);
                    const stopLossWarning = buy.stop_loss_corrected ? 
                        '<span class="badge bg-warning text-dark ms-1">Stop Loss Corrected</span>' : '';
                    
                    buyHtml += `
                        <div class="form-check mb-3 p-3 border rounded ai-recommendation" data-index="${index}">
                            <div class="d-flex align-items-start mb-2">
                                <input class="form-check-input buy-checkbox me-2" type="checkbox" id="buy_${index}" 
                                       data-ticker="${buy.ticker}" data-index="${index}">
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <strong>${buy.ticker}</strong>
                                            <span class="badge bg-success">BUY</span>
                                            ${stopLossWarning}
                                        </div>
                                        <div class="text-end">
                                            <a href="https://finance.yahoo.com/quote/${buy.ticker}/" target="_blank" class="btn btn-sm btn-outline-primary">
                                                üìä Yahoo Finance
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <div class="row g-2 mb-2">
                                        <div class="col-md-4">
                                            <label class="form-label small">Quantity</label>
                                            <input type="number" class="form-control form-control-sm ai-quantity" 
                                                   value="${buy.quantity}" min="1" data-index="${index}">
                                            <small class="text-muted">AI suggested: ${buy.quantity}</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Price ($)</label>
                                            <input type="number" class="form-control form-control-sm ai-price" 
                                                   value="${(buy.current_price || 0).toFixed(2)}" step="0.01" min="0.01" data-index="${index}">
                                            <small class="text-muted">Current: $${(buy.current_price || 0).toFixed(2)}</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Total Cost</label>
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">$</span>
                                                <input type="text" class="form-control ai-total-cost" readonly 
                                                       value="${totalCost.toFixed(2)}" data-index="${index}">
                                                <span class="input-group-text ai-cash-validation" data-index="${index}">üí∞</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row g-2 mb-2">
                                        <div class="col-md-6">
                                            <label class="form-label small">Stop Loss ($)</label>
                                            <input type="number" class="form-control form-control-sm ai-stop-loss" 
                                                   value="${buy.stop_loss_price?.toFixed(2) || ''}" step="0.01" data-index="${index}">
                                            <small class="text-muted">AI suggested: $${buy.stop_loss_price?.toFixed(2) || 'N/A'}</small>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">Reason</label>
                                            <input type="text" class="form-control form-control-sm ai-reason" 
                                                   value="${buy.reason}" data-index="${index}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('buyRecommendationsContainer').innerHTML = buyHtml;
                document.getElementById('buyRecommendationsSection').style.display = 'block';
                
                // Add event listeners for real-time calculations
                addAIRecommendationListeners();
            }

            // Show execute trades button and initialize cash tracking
            document.getElementById('executeTradesSection').style.display = 'block';
            
            // Initialize cash tracking
            initializeCashTracking(recommendations);
        }
        
        async function initializeCashTracking(recommendations) {
            // Get actual cash balance from portfolio API instead of OpenAI response
            try {
                const response = await fetch('/api/portfolio/summary');
                const portfolioData = await response.json();
                const actualCash = portfolioData.cash_balance || 10000;
                
                document.getElementById('currentCash').textContent = `$${actualCash.toLocaleString()}`;
                document.getElementById('selectedCosts').textContent = '$0';
                document.getElementById('remainingCash').textContent = `$${actualCash.toLocaleString()}`;
                document.getElementById('cashTotalDisplay').style.display = 'block';
                
                console.log(`Using actual cash from portfolio: $${actualCash} (OpenAI suggested: $${recommendations.remaining_cash || 'N/A'})`);
            } catch (error) {
                console.error('Failed to get actual cash balance, using fallback:', error);
                const fallbackCash = 10000;
                document.getElementById('currentCash').textContent = `$${fallbackCash.toLocaleString()}`;
                document.getElementById('selectedCosts').textContent = '$0';
                document.getElementById('remainingCash').textContent = `$${fallbackCash.toLocaleString()}`;
                document.getElementById('cashTotalDisplay').style.display = 'block';
            }
            
            // Add event listeners to buy checkboxes
            document.querySelectorAll('.buy-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateCashTotal);
            });
        }
        
        function updateCashTotal() {
            const currentCash = parseFloat(document.getElementById('currentCash').textContent.replace(/[$,]/g, ''));
            let totalSelectedCosts = 0;
            
            // Calculate total cost of selected buy recommendations
            document.querySelectorAll('.buy-checkbox:checked').forEach(checkbox => {
                const cost = parseFloat(checkbox.dataset.cost || 0);
                totalSelectedCosts += cost;
            });
            
            const remainingCash = currentCash - totalSelectedCosts;
            
            // Update display
            document.getElementById('selectedCosts').textContent = `$${totalSelectedCosts.toLocaleString()}`;
            document.getElementById('remainingCash').textContent = `$${remainingCash.toLocaleString()}`;
            
            // Color code remaining cash
            const remainingCashElement = document.getElementById('remainingCash');
            if (remainingCash < 0) {
                remainingCashElement.style.color = 'red';
                remainingCashElement.style.fontWeight = 'bold';
            } else if (remainingCash < 500) {
                remainingCashElement.style.color = 'orange';
                remainingCashElement.style.fontWeight = 'bold';
            } else {
                remainingCashElement.style.color = 'green';
                remainingCashElement.style.fontWeight = 'normal';
            }
        }

        // AI Recommendation real-time calculation functions
        function addAIRecommendationListeners() {
            // Add event listeners for buy recommendations
            document.querySelectorAll('.ai-quantity').forEach(input => {
                input.addEventListener('input', (e) => calculateAITotalCost(e.target.dataset.index));
            });
            
            document.querySelectorAll('.ai-price').forEach(input => {
                input.addEventListener('input', (e) => calculateAITotalCost(e.target.dataset.index));
            });
            
            // Initial calculation for all recommendations
            document.querySelectorAll('.ai-quantity').forEach(input => {
                calculateAITotalCost(input.dataset.index);
            });
        }

        function addAISellRecommendationListeners() {
            // Add event listeners for sell recommendations
            document.querySelectorAll('.ai-sell-quantity').forEach(input => {
                input.addEventListener('input', (e) => calculateAISellTotalValue(e.target.dataset.index));
            });
            
            document.querySelectorAll('.ai-sell-price').forEach(input => {
                input.addEventListener('input', (e) => calculateAISellTotalValue(e.target.dataset.index));
            });
            
            // Initial calculation for all sell recommendations
            document.querySelectorAll('.ai-sell-quantity').forEach(input => {
                calculateAISellTotalValue(input.dataset.index);
            });
        }

        function calculateAITotalCost(index) {
            const quantityInput = document.querySelector(`.ai-quantity[data-index="${index}"]`);
            const priceInput = document.querySelector(`.ai-price[data-index="${index}"]`);
            const totalCostInput = document.querySelector(`.ai-total-cost[data-index="${index}"]`);
            const cashValidation = document.querySelector(`.ai-cash-validation[data-index="${index}"]`);
            const checkbox = document.querySelector(`#buy_${index}`);
            
            if (!quantityInput || !priceInput || !totalCostInput) return;
            
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const totalCost = quantity * price;
            
            totalCostInput.value = totalCost.toFixed(2);
            
            // Update checkbox data-cost for cash tracking
            if (checkbox) {
                checkbox.dataset.cost = totalCost.toFixed(2);
            }
            
            // Get current available cash
            const currentCashText = document.getElementById('currentCash')?.textContent || '$0';
            const availableCash = parseFloat(currentCashText.replace(/[$,]/g, ''));
            
            // Update cash validation indicator
            if (totalCost > availableCash) {
                cashValidation.innerHTML = '‚ùå';
                cashValidation.className = 'input-group-text text-danger';
            } else if (totalCost > 0) {
                cashValidation.innerHTML = '‚úÖ';
                cashValidation.className = 'input-group-text text-success';
            } else {
                cashValidation.innerHTML = 'üí∞';
                cashValidation.className = 'input-group-text';
            }
            
            // Update overall cash total if checkbox is checked
            if (checkbox && checkbox.checked) {
                updateCashTotal();
            }
        }

        function calculateAISellTotalValue(index) {
            const quantityInput = document.querySelector(`.ai-sell-quantity[data-index="${index}"]`);
            const priceInput = document.querySelector(`.ai-sell-price[data-index="${index}"]`);
            const totalValueInput = document.querySelector(`.ai-sell-total-value[data-index="${index}"]`);
            
            if (!quantityInput || !priceInput || !totalValueInput) return;
            
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const totalValue = quantity * price;
            
            totalValueInput.value = totalValue.toFixed(2);
        }

        async function executeSelectedTrades() {
            const btn = document.getElementById('executeTradesBtn');
            const spinner = document.getElementById('executeLoadingSpinner');
            
            // Get selected trades
            const selectedBuys = [];
            const selectedSells = [];
            
            // Get selected buy recommendations with edited values
            document.querySelectorAll('input[id^="buy_"]:checked').forEach(checkbox => {
                const index = checkbox.dataset.index;
                const ticker = checkbox.dataset.ticker;
                
                // Get edited values from the form
                const quantity = parseInt(document.querySelector(`.ai-quantity[data-index="${index}"]`).value);
                const price = parseFloat(document.querySelector(`.ai-price[data-index="${index}"]`).value);
                const stopLoss = parseFloat(document.querySelector(`.ai-stop-loss[data-index="${index}"]`).value) || null;
                const reason = document.querySelector(`.ai-reason[data-index="${index}"]`).value;
                
                selectedBuys.push({
                    ticker: ticker,
                    quantity: quantity,
                    current_price: price,
                    stop_loss_price: stopLoss,
                    reason: reason
                });
            });
            
            // Get selected sell recommendations with edited values
            document.querySelectorAll('input[id^="sell_"]:checked').forEach(checkbox => {
                const index = checkbox.dataset.index;
                const ticker = checkbox.dataset.ticker;
                const action = checkbox.dataset.action;
                
                // Get edited values from the form
                const quantity = parseInt(document.querySelector(`.ai-sell-quantity[data-index="${index}"]`).value);
                const price = parseFloat(document.querySelector(`.ai-sell-price[data-index="${index}"]`).value);
                const reason = document.querySelector(`.ai-sell-reason[data-index="${index}"]`).value;
                
                selectedSells.push({
                    ticker: ticker,
                    quantity: quantity,
                    current_price: price,
                    action: action,
                    reason: reason
                });
            });
            
            if (selectedBuys.length === 0 && selectedSells.length === 0) {
                alert('Please select at least one recommendation to execute.');
                return;
            }
            
            btn.disabled = true;
            spinner.classList.remove('d-none');
            
            try {
                const response = await fetch('/api/ai/execute-trades', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        selected_buys: selectedBuys,
                        selected_sells: selectedSells
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayExecutionResults(data);
                    // Refresh portfolio data after successful trades
                    loadPortfolioSummary();
                } else {
                    document.getElementById('aiResultsContainer').innerHTML = 
                        `<div class="alert alert-danger">Error: ${data.error || 'Failed to execute trades'}</div>`;
                    document.getElementById('aiResultsSection').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('aiResultsContainer').innerHTML = 
                    `<div class="alert alert-danger">Error: ${error.message}</div>`;
                document.getElementById('aiResultsSection').style.display = 'block';
            } finally {
                btn.disabled = false;
                spinner.classList.add('d-none');
            }
        }

        function displayExecutionResults(results) {
            let resultsHtml = '';
            
            // Display buy results
            if (results.buy_results && results.buy_results.length > 0) {
                resultsHtml += '<h6 class="text-success">‚úÖ Buy Orders Executed:</h6><ul>';
                results.buy_results.forEach(result => {
                    resultsHtml += `<li class="text-success">${result.message}</li>`;
                });
                resultsHtml += '</ul>';
            }
            
            // Display sell results
            if (results.sell_results && results.sell_results.length > 0) {
                resultsHtml += '<h6 class="text-info">üí∞ Sell Orders Executed:</h6><ul>';
                results.sell_results.forEach(result => {
                    const gainLossText = result.gain_loss >= 0 ? `+$${result.gain_loss.toFixed(2)}` : `$${result.gain_loss.toFixed(2)}`;
                    resultsHtml += `<li class="text-info">${result.message} (P&L: ${gainLossText})</li>`;
                });
                resultsHtml += '</ul>';
            }
            
            // Display errors
            if (results.errors && results.errors.length > 0) {
                resultsHtml += '<h6 class="text-danger">‚ùå Errors:</h6><ul>';
                results.errors.forEach(error => {
                    resultsHtml += `<li class="text-danger">${error}</li>`;
                });
                resultsHtml += '</ul>';
            }
            
            if (!resultsHtml) {
                resultsHtml = '<div class="alert alert-info">No trades were executed.</div>';
            }
            
            document.getElementById('aiResultsContainer').innerHTML = resultsHtml;
            document.getElementById('aiResultsSection').style.display = 'block';
        }

        // Event listeners for AI predictor
        document.getElementById('getRecommendationsBtn').addEventListener('click', getAIRecommendations);
        document.getElementById('executeTradesBtn').addEventListener('click', executeSelectedTrades);

        // Tab change handlers
        document.getElementById('portfolio-tab').addEventListener('click', () => {
            loadPortfolioSummary();
            loadPortfolioPerformance();
        });

        document.getElementById('trade-tab').addEventListener('click', () => {
            loadAvailableCash();
        });

        document.getElementById('transactions-tab').addEventListener('click', () => {
            loadTransactions();
        });

        // Load default portfolio on page load
        window.addEventListener('load', () => {
            loadPortfolioSummary();
            loadPortfolioPerformance();
            loadAvailableCash();
        });
    </script>
</body>
</html>
